<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>Document</title>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				background-color: rgb(15, 6, 54);
				display: grid;
				place-items: center;
				height: 100vh;
			}

			#grid {
				display: grid;
				grid-template-columns: repeat(3, 200px);
				grid-template-rows: repeat(3, 200px);
				gap: 20px;
				padding: 40px;
				border-radius: 20px;
				background-color: azure;
			}

			.tile {
				font-size: 100px;
				display: grid;
				place-items: center;
			}

			.tile:not(.blank) {
				background-color: white;
				border: 2px solid black;
				border-radius: 10px;
				box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.477);
			}
		</style>
	</head>
	<body>
		<div id="grid"></div>

		<script>
			"use strict";

			function checkForWinCondition(tiles) {
				const winState = tiles.every((tile, i) => {
					const num = Number(tile.innerHTML);

					return num === i + 1 || num === i + 2 || num === 0; //Empty tile translates to 0
				});

				if (winState) {
					alert("You won!!");
				}
			}

			function handleTileClick(tiles, e) {
				const tile = e.target;
				const tileIndex = Number(tile.id.match(/\d+/));
				const boardSize = Math.sqrt(tiles.length);

				const neighbors = [
					tileIndex + 1,
					tileIndex - 1,
					tileIndex + boardSize,
					tileIndex - boardSize,
				]
					.filter(i => i >= 0 && i <= tiles.length - 1)
					.map(i => tiles[i]);

				const blankTile = neighbors.find(n =>
					n.classList.contains("blank")
				);
				if (!blankTile) return;

				tile.classList.add("blank");
				blankTile.classList.remove("blank");
				blankTile.innerHTML = tile.innerHTML;
				tile.innerHTML = "";

				setTimeout(() => {
					checkForWinCondition(tiles);
				}, 3);
			}

			function shuffleArray(array) {
				for (let i = array.length - 1; i > 0; i--) {
					// Pick a remaining element at random index `j` from 0 to `i`
					const j = Math.floor(Math.random() * (i + 1));

					// Swap the elements at indices `i` and `j`
					[array[i], array[j]] = [array[j], array[i]];
				}
				return array;
			}

			function checkPuzzleSolvability(puzzleArrangement) {
				const puzzleSize = Math.sqrt(puzzleArrangement.length);
				let inversionCount = 0;

				for (let i = 0; i < puzzleArrangement.length - 1; i++) {
					for (let j = i + 1; j < puzzleArrangement.length; j++) {
						if (
							puzzleArrangement[i] > 0 &&
							puzzleArrangement[j] > 0 &&
							puzzleArrangement[i] > puzzleArrangement[j]
						)
							inversionCount++;
					}
				}

				if (puzzleSize % 2 == 1)
					// Grid is odd sized
					return inversionCount % 2 == 0;
				else {
					const blankPos =
						puzzleSize -
						Math.floor(puzzleArrangement.indexOf(0) / puzzleSize);
					if (blankPos % 2 == 1) return inversionCount % 2 == 0;
					else return inversionCount % 2 == 1;
				}
			}

			function setup(boardSize = 3) {
				const board = document.getElementById("grid");
				board.style.gridTemplateColumns = `repeat(${boardSize},150px)`;
				board.style.gridTemplateRows = `repeat(${boardSize},150px)`;

				for (let i = 0; i < boardSize ** 2; i++) {
					const tile = document.createElement("div");
					tile.id = `tile${i}`;
					tile.className = "tile";
					board.appendChild(tile);
				}

				const tiles = Array.from(
					document.querySelectorAll(".tile").values()
				);

				for (const tile of tiles) {
					tile.addEventListener(
						"click",
						handleTileClick.bind(null, tiles)
					);
				}

				const initialPositions = Array.from(
					{ length: boardSize ** 2 },
					(_, i) => i
				);

				let attempts = 0;
				do {
					shuffleArray(initialPositions);
					attempts++;
				} while (!checkPuzzleSolvability(initialPositions));

				console.log(attempts);

				tiles.forEach((tile, i) => {
					const val = initialPositions[i];
					if (val === 0) [tile.classList.add("blank")];
					else tile.innerHTML = val;
				});

				checkPuzzleSolvability(initialPositions);
			}

			setup(4);
		</script>
	</body>
</html>
